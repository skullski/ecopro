import { execFile } from 'child_process';

export type MalwareScanResult = { ok: true } | { ok: false; reason: string };

// Malware scanning using ClamAV (clamscan) when available.
// In production, set CLAMAV_SCAN=true to require scan success.
export async function scanFileForMalware(filePath: string): Promise<MalwareScanResult> {
  const requireScan = process.env.NODE_ENV === 'production'
    ? process.env.CLAMAV_SCAN !== 'false'
    : process.env.CLAMAV_SCAN === 'true';

  if (!requireScan) return { ok: true };

  const bin = process.env.CLAMAV_BIN || 'clamscan';

  return new Promise((resolve) => {
    execFile(bin, ['--no-summary', '--infected', filePath], { timeout: 60_000 }, (err) => {
      if (!err) return resolve({ ok: true });

      const anyErr = err as any;
      // clamscan exit codes: 0 = clean, 1 = infected, 2+ = error
      const code = typeof anyErr?.code === 'number' ? anyErr.code : null;
      if (code === 1) return resolve({ ok: false, reason: 'File failed malware scan' });

      return resolve({ ok: false, reason: 'Malware scanner unavailable or errored' });
    });
  });
}
