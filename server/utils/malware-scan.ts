import { execFile } from 'child_process';
import { existsSync } from 'fs';
import { exec } from 'child_process';

export type MalwareScanResult = { ok: true } | { ok: false; reason: string };

// Check if ClamAV is available on the system
let clamavAvailable: boolean | null = null;

async function checkClamavAvailable(bin: string): Promise<boolean> {
  if (clamavAvailable !== null) return clamavAvailable;
  
  return new Promise((resolve) => {
    exec(`which ${bin}`, (err) => {
      clamavAvailable = !err;
      if (!clamavAvailable) {
        console.log('[MalwareScan] ClamAV not available on this system, skipping malware scans');
      }
      resolve(clamavAvailable);
    });
  });
}

// Malware scanning using ClamAV (clamscan) when available.
// Scans are skipped if ClamAV is not installed.
// Set CLAMAV_SCAN=true to enable, CLAMAV_SCAN=false to disable.
export async function scanFileForMalware(filePath: string): Promise<MalwareScanResult> {
  // Explicit disable
  if (process.env.CLAMAV_SCAN === 'false') return { ok: true };
  
  // Only scan if explicitly enabled or in production with ClamAV available
  const bin = process.env.CLAMAV_BIN || 'clamscan';
  
  // Check if ClamAV is available
  const available = await checkClamavAvailable(bin);
  if (!available) {
    // ClamAV not installed - skip scan (don't fail uploads)
    return { ok: true };
  }

  return new Promise((resolve) => {
    execFile(bin, ['--no-summary', '--infected', filePath], { timeout: 60_000 }, (err) => {
      if (!err) return resolve({ ok: true });

      const anyErr = err as any;
      // clamscan exit codes: 0 = clean, 1 = infected, 2+ = error
      const code = typeof anyErr?.code === 'number' ? anyErr.code : null;
      if (code === 1) return resolve({ ok: false, reason: 'File failed malware scan' });

      // Scanner errored - skip scan rather than block uploads
      console.warn('[MalwareScan] Scanner error, allowing upload:', anyErr?.message);
      return resolve({ ok: true });
    });
  });
}
